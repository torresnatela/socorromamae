# Story 1.3: Frontend Authentication & Route Protection

## Status

In Progress

## Story

**As a** caregiver,  
**I want** to sign up, log in, and stay logged in with session-aware route protection on the web app,  
**so that** I can access the potty-training module only after authenticating while keeping my session secure and compliant.

## Acceptance Criteria

1. `(unauth)` layout pages provide signup, login, and forgot/reset password screens using React Hook Form + Zod, calling `/api/v1/auth/signup|login|password-reset|password-reset/confirm` with `lgpdAccepted` and `keepSignedIn` fields; inline errors surface backend envelope errors and LGPD consent messaging. [Source: docs/architecture.md#frontend-architecture-nextjs-app-router; docs/api/authentication.md#post-apiv1authsignup]
2. Session bootstrap uses `/api/v1/auth/me` on initial load to hydrate caregiver/subscription/consent state; private routes live under `(gated)` and redirect to `(unauth)` while a loading/blocked state renders until auth settles. [Source: docs/architecture.md#frontend-architecture-nextjs-app-router; docs/api/authentication.md#get-apiv1authme]
3. “Keep me signed in” persists via `keepSignedIn` flag and periodic `/api/v1/auth/refresh` calls; logout clears the HTTP-only cookie via `/api/v1/auth/logout` and invalidates React Query caches so gated pages immediately lock. [Source: docs/architecture.md#auth--consent; docs/api/authentication.md#post-apiv1authrefresh]
4. Guards block chat/progress/subscription routes until both authenticated session and consent are present; unauthorized or expired sessions show a friendly prompt with a CTA back to login. [Source: docs/architecture.md#frontend-architecture-nextjs-app-router; docs/prd.md#epic-1--foundations-auth--baby-registration]
5. Tests cover form validation, happy/error auth flows (mocked API), and guard behavior; lint/type checks pass without regressions. [Source: docs/architecture.md#testing-strategy]

## Tasks / Subtasks

- [ ] Build `(unauth)` auth pages (AC: 1)  
  - [ ] Create signup page with email/password/fullName fields, LGPD consent checkbox, `keepSignedIn` toggle, and submit via React Hook Form + Zod schemas aligned to `/api/v1/auth/signup`; surface envelope errors. [Source: docs/architecture.md#frontend-architecture-nextjs-app-router; docs/api/authentication.md#post-apiv1authsignup]  
  - [x] Create login page that posts `/api/v1/auth/login` with `keepSignedIn`; render inline errors and success redirect. [Source: docs/architecture.md#frontend-architecture-nextjs-app-router; docs/api/authentication.md#post-apiv1authlogin]  
  - [x] Implement forgot password + reset pages wired to `/api/v1/auth/password-reset` and `/api/v1/auth/password-reset/confirm` with form validation and success states. [Source: docs/api/authentication.md#post-apiv1authpassword-reset]

- [x] Implement session bootstrap and guards (AC: 2,4)  
  - [x] Add auth provider/hooks using React Query to fetch `/api/v1/auth/me`, storing caregiver/subscription/consent snapshot and exposed loading/error states for layouts. [Source: docs/api/authentication.md#get-apiv1authme; docs/architecture.md#frontend-architecture-nextjs-app-router]  
  - [x] Wrap gated routes with a guard component that blocks rendering until session/consent are valid, redirects to `(unauth)` on 401/403, and shows a loading/blocked fallback while checks run. [Source: docs/prd.md#epic-1--foundations-auth--baby-registration; docs/architecture.md#frontend-architecture-nextjs-app-router]

- [ ] Handle session persistence and logout (AC: 3)  
  - [ ] Implement “keep me signed in” refresh loop hitting `/api/v1/auth/refresh` before expiry when the flag is true; otherwise use default shorter session. [Source: docs/architecture.md#auth--consent; docs/api/authentication.md#post-apiv1authrefresh]  
  - [ ] Add logout action that calls `/api/v1/auth/logout`, clears caches, and routes users to `(unauth)` while showing confirmation. [Source: docs/api/authentication.md#post-apiv1authlogout]

- [ ] Quality and tests (AC: 5)  
  - [ ] Write Vitest + Testing Library specs for form schemas, auth hooks/provider, and guard rendering/redirect behavior with mocked API responses. [Source: docs/architecture.md#testing-strategy]  
  - [ ] Run lint and unit test suite; document any remaining gaps for QA. [Source: docs/architecture.md#testing-strategy]

## Dev Notes

### Previous Story Insights

- Current repo runs as a single Next.js 14 App Router app (no Turborepo packages); UI pages already live under `/app/**` with shared components and static data mocks from the base UX import. [Source: docs/stories/1.2.base-ux-import.md]

### Data Models

- Auth responses include `caregiverId`, `sessionExpiresAt`, and nested `subscription` status (`trialing/active/past_due/canceled`) from the auth endpoints. [Source: docs/api/authentication.md#get-apiv1authme]

### API Specifications

- `/api/v1/auth/signup` accepts `email`, `password`, `fullName`, `lgpdAccepted`, and optional `keepSignedIn`, returns session metadata and subscription info. [Source: docs/api/authentication.md#post-apiv1authsignup]  
- `/api/v1/auth/login` reissues the session cookie with the same response shape; `/api/v1/auth/refresh` renews tokens (optionally `keepSignedIn`). [Source: docs/api/authentication.md#post-apiv1authlogin; docs/api/authentication.md#post-apiv1authrefresh]  
- `/api/v1/auth/logout` clears the `sm.session` HTTP-only cookie; `/api/v1/auth/me` bootstraps caregiver/session state. [Source: docs/api/authentication.md#post-apiv1authlogout; docs/api/authentication.md#get-apiv1authme]  
- Password reset flows live at `/api/v1/auth/password-reset` and `/api/v1/auth/password-reset/confirm`, returning `{ data: { success: true } }` on success. [Source: docs/api/authentication.md#post-apiv1authpassword-reset]

### Component Specifications

- Auth UX uses React Hook Form + Zod resolvers to validate inputs and forward payloads to `/api/v1/auth/*`; React Query manages client caching, and `(unauth)` / `(gated)` layouts partition public vs protected routes. [Source: docs/architecture.md#frontend-architecture-nextjs-app-router]

### File Locations & Project Structure Notes

- Architecture assumes `apps/app` with `packages/{config,shared,ui}`, but the current codebase is a single Next.js app with routes under `/app/**` and shared components in `/components`; align new auth pages/hooks within this existing structure unless the workspace is expanded later. [Source: docs/architecture.md#repository-structure; docs/stories/1.2.base-ux-import.md]

### Technical Constraints

- Backend issues short-lived JWT cookies signed with `AUTH_JWT_SECRET`; `keepSignedIn` extends cookie lifetime to 30 days, otherwise ~8 hours. [Source: docs/architecture.md#auth--consent]  
- All error responses follow `{ meta, error }` envelope; frontend should display these messages inline in forms/guards. [Source: docs/api/authentication.md#response-envelope]  
- LGPD consent must be captured during signup (`lgpdAccepted: true`) and represented in the session snapshot to gate downstream routes. [Source: docs/prd.md#epic-1--foundations-auth--baby-registration; docs/api/authentication.md#post-apiv1authsignup]

### Testing Requirements

- Use Vitest + Testing Library for components/hooks and Zod schemas; integration/e2e can extend later with Playwright once auth UI solidifies. [Source: docs/architecture.md#testing-strategy]

## Project Structure Alignment

- Architecture references a sharded docs/architecture folder, but only `docs/architecture.md` exists; follow the monolithic document for this story. [Source: docs/architecture.md]

## Change Log

| Date       | Version | Description                             | Author       |
| ---------- | ------- | --------------------------------------- | ------------ |
| 2025-11-18 | 0.1     | Draft story for frontend auth & guards  | Scrum Master |
| 2025-11-18 | 0.2     | Added password reset UX + session guard foundation | James (dev) |

## Dev Agent Record

### Agent Model Used

- gpt-5 (Codex CLI)

### Debug Log References

- None for this iteration.

### Completion Notes List

- Login page now usa React Hook Form + Zod, chamando `/api/v1/auth/login` com tratamento de envelope de erro e sucesso.
- Alternância de “manter-me conectado” ativa o `keepSignedIn` e redireciona para `/home` após sucesso.
- `npm run lint` falhou localmente porque o pacote `esutils` veio sem `lib/utils.js`; preciso revisar cache/npm para restaurar esse arquivo.
- Adicionei as telas de “Esqueci a senha” e “Redefinir senha” com validação Zod, estados de sucesso/erro e chamadas para `/api/v1/auth/password-reset` e `/api/v1/auth/password-reset/confirm`.
- Criei bootstrap de sessão com React Query + `AuthGuard` que bloqueia/mostra fallback e redireciona rotas protegidas (home, chat, progress, subscription) quando a sessão/consentimento não estão presentes.
- Incluí `@tanstack/react-query` nas dependências e ajustei o teste de subscription para utilizar uma sessão mockada.
- Restaurei `esutils/lib/utils.js` e `keyword.js` diretamente do pacote, desbloqueando o `npm run lint`, que agora passa; `npm test` falhou com “Bus error (core dumped)” e precisa de investigação ambiental.
- Acrescentei CTA de “Esqueci minha senha” na tela de login apontando para `/forgot-password`.

### File List

- app/login/page.tsx
- app/forgot-password/page.tsx
- app/reset-password/page.tsx
- app/home/page.tsx
- app/chat/page.tsx
- app/progress/page.tsx
- app/subscription/page.tsx
- app/subscription/page.test.tsx
- app/layout.tsx
- app/providers.tsx
- components/navigation/app-shell.tsx
- components/auth/auth-guard.tsx
- src/domain/auth/session.ts
- package.json
- package-lock.json

## QA Results

_To be completed by the QA Agent._
