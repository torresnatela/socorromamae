# Test Design: Story 1.1

Date: 2025-11-16
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 12
- Unit tests: 3 (25%)
- Integration tests: 6 (50%)
- E2E tests: 3 (25%)
- Priority distribution: P0: 7, P1: 5, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Shows signup/login screens with email/password and federated options, plus LGPD consent checkbox.

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 1.1-UNIT-001   | Unit        | P0       | Zod signup schema enforces required fields, LGPD checkbox and provider payloads. | Pure validation logic with compliance impact should fail fast without hitting APIs. |
| 1.1-INT-001    | Integration | P0       | `/api/v1/auth/signup` creates caregiver, requires consent flag, and returns `{data, meta}` envelope. | Validates service + Supabase orchestration and response contract users rely on. |
| 1.1-INT-004    | Integration | P1       | `/api/v1/auth/login` handles password and federated providers, returning JWT cookies. | Ensures interaction between auth service, Supabase auth, and cookie issuance. |
| 1.1-E2E-001    | E2E         | P0       | User signs up via `(unauth)` UI and cannot submit until LGPD is checked; successful signup routes to gated area. | Critical LGPD compliance journey spanning UI, API, and consent requirement. |

### AC2: Blocks access to the module until consent is accepted; logs consent timestamp per user.

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 1.1-UNIT-002   | Unit        | P0       | Consent guard hook/component denies `(gated)` rendering until both consent + subscription flags are true. | Isolated logic deciding gating; must be deterministic and simple to debug. |
| 1.1-INT-002    | Integration | P0       | Consent repository writes `caregiver_consents` row with `lgpd_terms`, `LGPD_CONSENT_VERSION`, and timestamp on acceptance. | Verifies DB interaction plus auditing guarantees. |
| 1.1-INT-005    | Integration | P0       | `/api/v1/auth/me` denies access (403 + error payload) when consent missing and returns consent snapshot when accepted. | Confirms API + middleware enforce gate before UI loads data. |
| 1.1-E2E-002    | E2E         | P0       | Authenticated caregiver without consent is blocked from `(gated)` layout and shown localized messaging until consenting. | Compliance-critical experience; ensures guard + API wiring function end to end. |

### AC3: Supports password reset and session persistence up to 30 days.

| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 1.1-UNIT-003   | Unit        | P1       | Session helper computes cookie expirations (default vs "keep me logged in") and refresh window lengths. | Pure time arithmetic that must stay correct and fast to catch regressions. |
| 1.1-INT-003    | Integration | P1       | `/api/v1/auth/forgot-password` orchestration triggers Supabase reset email and returns normalized success/error payloads. | Exercises service + Supabase SDK interactions including error handling. |
| 1.1-INT-006    | Integration | P1       | `/api/v1/auth/refresh` rotates JWT, respects consent state, and persists 30-day session when requested. | Ensures cookie + DB workflow across auth service layers. |
| 1.1-E2E-003    | E2E         | P1       | Caregiver selects "Keep me logged in" and remains authenticated after browser restart and 30-day simulated advance. | Validates real browser cookie behavior plus refresh loop. |

## Risk Coverage

- No prior risk profile exists; tests above provide defense-in-depth for LGPD consent, authentication, and session persistence.

## Recommended Execution Order

1. Execute all P0 unit tests (1.1-UNIT-001, 1.1-UNIT-002) for immediate feedback.
2. Run P0 integration tests (1.1-INT-001, 1.1-INT-002, 1.1-INT-005) to validate service + DB flows.
3. Execute P0 E2E journeys (1.1-E2E-001, 1.1-E2E-002) for compliance confidence.
4. Complete remaining P1 unit/integration tests (1.1-UNIT-003, 1.1-INT-003, 1.1-INT-004, 1.1-INT-006).
5. Finish P1 E2E regression (1.1-E2E-003) to validate long-lived sessions.

## Detailed Test Specifications (Unit & Integration)

### Unit Tests

| ID           | Target Module                                      | Inputs / Variations                                                                                                                                                                     | Assertions                                                                                                                                                                                                                                       | Notes |
| ------------ | -------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----- |
| 1.1-UNIT-001 | `packages/shared/auth/schemas.ts` (signup schema)  | - Valid payload with `lgpdAccepted: true`<br>- Missing required field (email, password, fullName)<br>- `lgpdAccepted: false`<br>- Unsupported `provider` string                         | - Successful parse returns normalized DTO (trims strings, lowercases email)<br>- Missing field throws Zod error with specific messages<br>- `lgpdAccepted: false` rejects with LGPD-specific error code<br>- Unsupported provider rejected         | Include regression for ULID meta if schema decorates outputs. |
| 1.1-UNIT-002 | `apps/app/src/modules/consent/useConsentGate.ts`   | - Consent true + subscription true<br>- Consent false + subscription true<br>- Consent true + subscription false<br>- Input undefined/null states                                      | - Hook/component returns `isGated` flag and reason code per branch<br>- When consent missing, error reason is `consent_required` and renders copy key<br>- Handles undefined input by defaulting to gated state                                    | Mock React Query context as needed; prefer pure function extraction. |
| 1.1-UNIT-003 | `packages/shared/auth/sessionHelpers.ts`           | - `keepLoggedIn=false`, `issuedAt=now`<br>- `keepLoggedIn=true` 30-day expectation<br>- Values near daylight saving change<br>- Refresh window boundary                                 | - Returns correct `expiresAt` for default vs keep-alive (e.g., now+24h vs now+30d)<br>- Refresh window matches spec (e.g., 5 minutes before expiry)<br>- Handles DST/timezone by using UTC; ensures monotonic increase                              | Use fake timers; assert cookie options (httpOnly, sameSite). |

### Integration Tests

| ID           | Target Flow / Endpoint                               | Pre-Conditions & Data                                                                                                                                                                                                                                            | Steps                                                                                                                                                                                                                                                                                                  | Expected Outcomes                                                                                                                                                                                                                                                                           |
| ------------ | ----------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.1-INT-001  | `POST /api/v1/auth/signup`                           | - Supabase test DB with empty `caregivers` table<br>- Env vars set (`LGPD_CONSENT_VERSION`, `AUTH_JWT_SECRET`)<br>- Supertest hitting Next.js route handler with mocked Supabase service-role key                                                                | 1. Issue POST with valid payload + consent true.<br>2. Repeat signup with same email.<br>3. Send payload missing consent or consent false.<br>4. Confirm response envelope format.                                                                                                                      | - First request creates caregiver row, consent record, returns `{ data, meta }` with ULID IDs.<br>- Duplicate email returns error (409) with `{ error.code: caregiver_exists }`.<br>- Missing consent returns 400 with error reason `lgpd_required`.<br>- JWT cookie set with secure/httpOnly flags. |
| 1.1-INT-002  | Consent repository / service write path               | - Seed caregiver row with Supabase user ID<br>- Set `LGPD_CONSENT_VERSION` env<br>- Use in-memory Postgres or Supabase container                                                                                                                                 | 1. Call repository method with caregiver + metadata.<br>2. Call twice with same version (idempotent?).<br>3. Call with legacy version to ensure new record inserted.                                                                                                                                      | - Inserts `lgpd_terms` row with correct version + timestamp.<br>- Duplicate acceptance with same version does not create second row (assert upsert behavior).<br>- Legacy version creates new row entry (auditing).                                                                           |
| 1.1-INT-003  | `POST /api/v1/auth/forgot-password`                  | - Supabase test double for `auth.resetPasswordForEmail` (stub to capture calls).                                                                                                                                                                                | 1. Submit valid email -> expect success message (even if user unknown).<br>2. Force Supabase error -> expect 500/400 mapped error.<br>3. Verify payload shape matches spec.                                                                                                                             | - Endpoint always returns 202 + generic message, no enumeration.<br>- Error surfaces as `{ error.code, message }` when Supabase fails.<br>- Supabase method invoked with correct template + redirect URL.                                                                                    |
| 1.1-INT-004  | `POST /api/v1/auth/login`                            | - Seed caregiver with Supabase credentials + consent.<br>- Provide social/federated stubbed provider handler.                                                                                                                                                   | 1. Login via email/password -> success response + cookie.<br>2. Invalid password -> 401 error payload.<br>3. Federated provider payload -> ensures redirect URL or token minted, stub data returned.<br>4. Consent missing -> expect consent-required error.                                           | - Successful login returns sanitized caregiver snapshot + subscription stub.<br>- Cookies set to secure/httpOnly with expected expiration.<br>- Error cases return correct HTTP codes and structured `error`.                                                                              |
| 1.1-INT-005  | `GET /api/v1/auth/me` middleware & handler            | - Session cookie fixture with/without consent claim.<br>- Supabase DB seeded with consent record (or not).                                                                                                                                                      | 1. Request with valid session + consent -> returns caregiver profile + consent data.<br>2. Request without consent -> 403 w/ `error.code=consent_required`.<br>3. Request with expired JWT -> 401 `session_expired`.<br>4. Validate caching headers absence (private). | - Handler reads JWT, hydrates subscription stub, returns envelope.<br>- Missing consent path ensures `caregiver_consents` checked and timestamp returned.<br>- Expired tokens revoked and cookie cleared.                                                                                      |
| 1.1-INT-006  | `POST /api/v1/auth/refresh`                          | - Seed refresh token store (if any) or rely on JWT rotation module.<br>- Provide session with keep-alive flag true/false.                                                                                                                                       | 1. Call refresh with keepAlive false -> new short-lived cookie.<br>2. keepAlive true -> 30-day cookie expiration.<br>3. Missing/invalid refresh token -> 401.<br>4. Consent revoked between sessions -> expect 403 requiring re-acceptance.                                                             | - Response returns new `sessionExpiresAt` field.<br>- Cookies replaced (old cleared).<br>- Consent check occurs every refresh.                                                                                                                                                              |
